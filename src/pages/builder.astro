---
/**
 * Prompt Builder Page
 * Interactive tool for constructing prompts with techniques
 * Route: /builder
 * 
 * NEW LAYOUT:
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  PROMPT BUILDER                                         â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  CATEGORIES          â”‚  TECHNIQUES                      â”‚
 * â”‚  â—‹ All (192)         â”‚  [Search techniques...]          â”‚
 * â”‚  â—‹ Context Eng (20)  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 * â”‚  ...                 â”‚  â”‚ Card Grid  â”‚            â”‚    â”‚
 * â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  SELECTED TECHNIQUES (3)                                â”‚
 * â”‚  [Chain-of-Thought Ã—] [ReAct Ã—] [Memory Strategies Ã—]   â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  PROMPT EDITOR + PREVIEW (collapsible)                  â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getAllTechniques, getCategories } from '@/lib/techniques';
import { getDefaultTemplates } from '@/lib/prompt-builder';
import type { TechniquesData } from '@/types/techniques';
import TechniqueSelector from '@/components/TechniqueSelector.astro';
import PromptPreview from '@/components/PromptPreview.astro';

// Load techniques data
const techniquesCollection = await getCollection('techniques');
const techniquesData = techniquesCollection[0]?.data as TechniquesData;
const allTechniques = getAllTechniques(techniquesData);
const categories = getCategories(techniquesData);
const templates = getDefaultTemplates();
---

<Layout title="Prompt Builder | Mnehmos Prompt Research" description="Build optimized prompts using proven techniques">
  <div class="builder-page" data-testid="prompt-builder">
    <header class="page-header">
      <h1>Prompt Builder</h1>
      <p class="lead">Construct optimized prompts using proven techniques</p>
    </header>

    <div class="builder-layout">
      <!-- Row 1: Technique Selection (2-column: Categories | Technique Grid) -->
      <section class="technique-panel glass-card" data-testid="technique-panel">
        <h2>
          <span class="icon">ğŸ§©</span>
          Select Techniques
        </h2>
        
        <TechniqueSelector 
          techniques={allTechniques} 
          categories={categories}
        />
      </section>

      <!-- Row 2: Selected Techniques Chips -->
      <section class="selected-panel glass-card" data-testid="selected-panel">
        <div class="selected-header">
          <h3>
            <span class="icon">âœ…</span>
            Selected Techniques
            <span class="selected-count" data-testid="selected-count">(0)</span>
          </h3>
          <button type="button" class="clear-selected-btn" data-testid="clear-selected" style="display: none;">
            Clear All
          </button>
        </div>
        <div class="selected-chips" data-testid="selected-techniques">
          <p class="empty-state">Click techniques above to add them to your prompt.</p>
        </div>
      </section>

      <!-- Row 3: Prompt Editor + Preview (Collapsible) -->
      <details class="editor-preview-section" open>
        <summary class="section-toggle">
          <span class="toggle-icon">â–¼</span>
          <span class="toggle-text">Prompt Configuration & Preview</span>
        </summary>

        <div class="editor-preview-grid">
          <!-- Editor Panel -->
          <section class="editor-panel glass-card" data-testid="prompt-editor">
            <h3>
              <span class="icon">âœï¸</span>
              Configure Prompt
            </h3>

            <form id="prompt-form" class="prompt-form">
              <!-- Role Input -->
              <div class="form-group">
                <label for="role-input">Role / Persona</label>
                <input 
                  type="text" 
                  id="role-input"
                  data-testid="role-input"
                  placeholder="You are an expert..."
                  autocomplete="off"
                />
                <span class="help-text">Define who the AI should be</span>
              </div>

              <!-- Task Input -->
              <div class="form-group">
                <label for="task-input">Task Description</label>
                <textarea 
                  id="task-input"
                  data-testid="task-input"
                  rows="3"
                  placeholder="Your task is to..."
                ></textarea>
                <span class="help-text">Describe what the AI should do</span>
              </div>

              <!-- Context Input -->
              <div class="form-group">
                <label for="context-input">Context / Examples</label>
                <textarea 
                  id="context-input"
                  data-testid="context-input"
                  rows="2"
                  placeholder="Additional context or examples..."
                ></textarea>
                <span class="help-text">Provide background information</span>
              </div>

              <!-- Output Format -->
              <div class="form-group">
                <label for="output-input">Output Format</label>
                <textarea 
                  id="output-input"
                  data-testid="output-input"
                  rows="2"
                  placeholder="Format your response as..."
                ></textarea>
                <span class="help-text">Specify the desired output format</span>
              </div>
            </form>

            <!-- Templates Section -->
            <div class="templates-section">
              <h4>Quick Templates</h4>
              <div class="template-grid">
                {templates.map((template) => (
                  <button 
                    type="button"
                    class="template-card"
                    data-testid="template-card"
                    data-template-id={template.id}
                    data-template-role={template.role}
                    data-template-task={template.task}
                    data-template-context={template.context}
                    data-template-output={template.output}
                    data-template-techniques={JSON.stringify(template.techniques)}
                  >
                    <span class="template-name">{template.name}</span>
                    <span class="template-desc">{template.description}</span>
                  </button>
                ))}
              </div>
            </div>
          </section>

          <!-- Preview Panel -->
          <section class="preview-panel glass-card" data-testid="prompt-preview">
            <div class="preview-header">
              <h3>
                <span class="icon">ğŸ‘ï¸</span>
                Preview
              </h3>
              <div class="stats">
                <span class="stat" data-testid="token-count" title="Estimated token count">
                  <span class="stat-icon">ğŸ“Š</span>
                  <span class="stat-value">0</span> tokens
                </span>
                <span class="stat quality-indicator" data-testid="quality-score" title="Prompt quality score">
                  <span class="stat-icon">â­</span>
                  <span class="stat-value">0</span>/100
                </span>
              </div>
            </div>

            <PromptPreview />

            <div class="action-buttons">
              <button type="button" class="btn btn-primary" data-testid="copy-button">
                <span class="btn-icon">ğŸ“‹</span>
                Copy to Clipboard
              </button>
              <button type="button" class="btn btn-secondary" data-testid="export-button">
                <span class="btn-icon">ğŸ“¥</span>
                Export
              </button>
              <button type="button" class="btn btn-ghost" data-testid="clear-button">
                <span class="btn-icon">ğŸ—‘ï¸</span>
                Clear All
              </button>
            </div>
          </section>
        </div>
      </details>
    </div>
  </div>

  <!-- Pass data to client-side script -->
  <script 
    id="techniques-data" 
    type="application/json"
    set:html={JSON.stringify(techniquesData)}
  />
</Layout>

<script>
  import { initPromptBuilder } from '@/scripts/prompt-builder';
  
  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    initPromptBuilder();
  });
</script>

<style>
  .builder-page {
    padding: var(--space-6) var(--space-4);
    max-width: 1600px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: var(--space-6);
  }

  .page-header h1 {
    font-size: var(--font-3xl);
    font-weight: var(--font-bold);
    background: linear-gradient(135deg, var(--interactive-default), var(--interactive-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
  }

  .lead {
    font-size: var(--font-lg);
    color: var(--text-secondary);
  }

  /* New stacked layout */
  .builder-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .glass-card {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-lg);
  }

  .glass-card h2,
  .glass-card h3 {
    font-size: var(--font-lg);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .icon {
    font-size: var(--font-base);
  }

  /* Technique Panel - Full Width */
  .technique-panel {
    width: 100%;
  }

  /* Selected Panel */
  .selected-panel {
    padding: var(--space-4) var(--space-6);
  }

  .selected-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
  }

  .selected-header h3 {
    margin-bottom: 0;
    font-size: var(--font-base);
  }

  .selected-count {
    font-weight: var(--font-normal);
    color: var(--text-tertiary);
    font-size: var(--font-sm);
  }

  .clear-selected-btn {
    padding: var(--space-1) var(--space-3);
    background: transparent;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: var(--font-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .clear-selected-btn:hover {
    background: color-mix(in srgb, var(--color-error) 10%, transparent);
    border-color: var(--color-error);
    color: var(--color-error);
  }

  .selected-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    min-height: 40px;
    align-items: center;
  }

  .empty-state {
    color: var(--text-tertiary);
    font-size: var(--font-sm);
    font-style: italic;
    width: 100%;
    margin: 0;
  }

  /* Technique Chip Styles */
  :global(.technique-chip) {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: color-mix(in srgb, var(--copper, var(--interactive-default)) 15%, transparent);
    border: 1px solid var(--copper, var(--interactive-default));
    border-radius: var(--radius-full);
    color: var(--copper-dark, var(--interactive-default));
    font-size: var(--font-sm);
    font-weight: var(--font-medium);
  }

  :global(.technique-chip .remove-btn) {
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--radius-full);
    color: currentColor;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    transition: all var(--transition-fast);
    padding: 0;
  }

  :global(.technique-chip .remove-btn:hover) {
    background: var(--copper, var(--interactive-default));
    color: white;
  }

  /* Editor/Preview Section (Collapsible) */
  .editor-preview-section {
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .section-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-6);
    background: var(--surface-glass);
    cursor: pointer;
    font-weight: var(--font-medium);
    color: var(--text-primary);
    user-select: none;
    transition: background var(--transition-fast);
  }

  .section-toggle:hover {
    background: var(--surface-hover);
  }

  .toggle-icon {
    font-size: var(--font-xs);
    transition: transform var(--transition-fast);
  }

  .editor-preview-section:not([open]) .toggle-icon {
    transform: rotate(-90deg);
  }

  .toggle-text {
    font-size: var(--font-base);
  }

  .editor-preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
    padding: var(--space-6);
    background: var(--surface-glass);
    border-top: 1px solid var(--border-default);
  }

  @media (max-width: 1100px) {
    .editor-preview-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Editor Panel */
  .editor-panel {
    padding: var(--space-5);
  }

  .prompt-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-group label {
    font-weight: var(--font-medium);
    color: var(--text-primary);
    font-size: var(--font-sm);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    background: var(--surface-overlay);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: inherit;
    font-size: var(--font-sm);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--interactive-default);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--interactive-default) 25%, transparent);
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: var(--text-tertiary);
  }

  .help-text {
    font-size: var(--font-xs);
    color: var(--text-tertiary);
  }

  /* Templates Section */
  .templates-section {
    margin-top: var(--space-5);
    padding-top: var(--space-5);
    border-top: 1px solid var(--border-default);
  }

  .templates-section h4 {
    font-size: var(--font-sm);
    font-weight: var(--font-medium);
    margin-bottom: var(--space-3);
    color: var(--text-secondary);
  }

  .template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-2);
  }

  .template-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-3);
    background: var(--surface-overlay);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
  }

  .template-card:hover {
    border-color: var(--interactive-default);
    background: var(--surface-hover);
    transform: translateY(-2px);
  }

  .template-name {
    font-weight: var(--font-medium);
    color: var(--text-primary);
    font-size: var(--font-sm);
  }

  .template-desc {
    font-size: var(--font-xs);
    color: var(--text-tertiary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Preview Panel */
  .preview-panel {
    padding: var(--space-5);
  }

  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .preview-header h3 {
    margin-bottom: 0;
  }

  .stats {
    display: flex;
    gap: var(--space-3);
  }

  .stat {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--font-xs);
    color: var(--text-secondary);
    padding: var(--space-1) var(--space-2);
    background: var(--surface-overlay);
    border-radius: var(--radius-md);
  }

  .stat-icon {
    font-size: var(--font-sm);
  }

  .quality-indicator {
    transition: background-color 0.3s;
  }

  .quality-indicator.poor {
    background: color-mix(in srgb, var(--color-error) 20%, transparent);
    color: var(--color-error);
  }

  .quality-indicator.fair {
    background: color-mix(in srgb, var(--color-warning) 20%, transparent);
    color: var(--color-warning);
  }

  .quality-indicator.good {
    background: color-mix(in srgb, var(--color-success) 20%, transparent);
    color: var(--color-success);
  }

  .quality-indicator.excellent {
    background: color-mix(in srgb, var(--interactive-default) 20%, transparent);
    color: var(--interactive-default);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-default);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-weight: var(--font-medium);
    font-size: var(--font-sm);
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .btn-icon {
    font-size: var(--font-sm);
  }

  .btn-primary {
    background: var(--interactive-default);
    color: white;
  }

  .btn-primary:hover {
    background: var(--interactive-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-secondary {
    background: var(--surface-overlay);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
  }

  .btn-secondary:hover {
    background: var(--surface-hover);
    border-color: var(--interactive-default);
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-secondary);
  }

  .btn-ghost:hover {
    background: var(--surface-overlay);
    color: var(--color-error);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .builder-page {
      padding: var(--space-4) var(--space-3);
    }

    .page-header h1 {
      font-size: var(--font-2xl);
    }

    .glass-card {
      padding: var(--space-4);
    }

    .editor-preview-grid {
      padding: var(--space-4);
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
